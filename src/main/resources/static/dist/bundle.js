(()=>{"use strict";function e(){const e=document.getElementById("code-editor");e.innerHTML="",monaco.editor.create(e,{value:"public class StudentCode {\n  public static void main(String[] args) {\n    // Write your code here\n  }\n}\n// Declare additional classes below",language:"java",theme:"vs-light",automaticLayout:!0})}let t=Date.now(),n=Date.now(),o=null,a=0,i=0,d=null;function s(e){const t=Math.floor(e/1e3),n=Math.floor(t/60),o=t%60;return String(n).padStart(2,"0")+":"+String(o).padStart(2,"0")}function c(){n||(n=Date.now(),o&&(i+=Date.now()-o,o=null))}function l(){o||(o=Date.now(),n&&(a+=Date.now()-n,n=null))}function r(){const e=Date.now(),d=e-t,c=a+(n?e-n:0),l=i+(o?e-o:0);document.getElementById("totalTimer").innerText=s(d),document.getElementById("onTaskTimer").innerText=s(c),document.getElementById("offTaskTimer").innerText=s(l)}document.addEventListener("visibilitychange",()=>{document.hidden?l():c()});const u="hintHistory",m="hintCounts",g="hintLevelCap",h=["conceptual","syntax","logic","step","reveal"];function p(){return JSON.parse(localStorage.getItem(m)||"{}")}function f(){return localStorage.getItem(g)||""}function y(){localStorage.setItem(m,"{}"),localStorage.setItem(g,"")}function I(){const e=JSON.parse(localStorage.getItem(u)||"[]"),t=document.getElementById("hintHistoryList");t.innerHTML="",e.length?e.forEach(e=>{const n=document.createElement("li");n.innerHTML=`\n      <span class="font-bold text-indigo-700">${e.type}</span> \n      <span class="text-gray-400 text-xs">${e.taskTitle}</span><br>\n      <span class="font-mono">${e.hint}</span>\n      <span class="block text-xs text-gray-400 mt-1">${new Date(e.ts).toLocaleString()}</span>\n    `,t.appendChild(n)}):t.innerHTML="<li>no hints yet…</li>"}function S(){document.querySelectorAll(".hint-btn").forEach(e=>{"conceptual"!==e.dataset.type?e.disabled=!0:e.disabled=!1})}function T(){document.querySelectorAll(".hint-btn").forEach(e=>{e.disabled=!1})}function w(){y(),T(),I()}function E(){localStorage.setItem("hintsUsed","0"),y(),localStorage.setItem("failedRuns","0"),window.totalStart=Date.now()}let b=null;document.addEventListener("DOMContentLoaded",()=>{e(),document.getElementById("closeHint").onclick=()=>{document.getElementById("hintModal").classList.add("hidden"),window.isHintModalOpen=!1,I(),c()},I(),function(){const e=document.getElementById("code-editor");e.addEventListener("focus",c),e.addEventListener("blur",l),setInterval(r,1e3),function(){function e(){d&&clearTimeout(d),window.isHintModalOpen||c(),d=setTimeout(()=>{l()},3e4)}["mousemove","keydown","mousedown","touchstart"].forEach(t=>window.addEventListener(t,e,!0)),e()}()}();const t=JSON.parse(localStorage.getItem("selectedTask")||"{}");document.getElementById("task-desc").innerText=t.description||"-",document.getElementById("task-exp").innerText=t.expectedOutput||"-";const n=document.getElementById("run-btn"),o=document.getElementById("score-btn"),s=document.getElementById("clear-btn"),y=document.getElementById("next-btn"),x=document.getElementById("run-output"),L=document.getElementById("run-score"),v=document.getElementById("score-output");S(),b=setTimeout(T,3e4),o.disabled=!0,L.innerText="–",n.addEventListener("click",async()=>{const e=await async function(e){const t=document.getElementById("code-editor").value,n=await fetch("/api/submissions/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t,problemId:e.id})});return n.ok?await n.json():{error:await n.text()}}(t);x.innerText=e.output||e.error||"Run failed!",e.success&&(o.disabled=!1)}),o.addEventListener("click",async()=>{o.disabled=!0;const e=await async function(e){r&&r();const t=document.getElementById("code-editor").value,n=parseInt(localStorage.getItem("loggedInUserId")||"1"),o=parseInt(localStorage.getItem("sessionNumber")||"1"),d=p(),s=Object.values(d).reduce((e,t)=>e+t,0),c=parseInt(localStorage.getItem("failedRuns")||"0"),l=Math.floor(a/1e3),u=Math.floor(i/1e3),m=Math.trunc(Date.now()/1e3),g=void 0!==window.totalStart?m-Math.trunc(window.totalStart/1e3):0,h=f(),y={problemId:e.id,userId:n,sessionNumber:o,code:t,hintsUsed:s,hintCounts:d,failedRuns:c,elapsedSeconds:g,timeLimitSeconds:300,onTaskTime:l,offTaskTime:u,hintLevelCap:h},I=await fetch("/api/submissions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});return I.ok?await I.json():{error:await I.text()}}(t);v.innerText=e.output||e.error||"Submit failed!",L.innerText=e.score??"–",e.success&&(y.disabled=!1,s.disabled=!0)}),s.addEventListener("click",()=>{e(),x.innerText=v.innerText="",L.innerText="–",E(),w(),o.disabled=!0,y.disabled=!0,s.disabled=!1,S(),clearTimeout(b),b=setTimeout(T,3e4)}),document.querySelectorAll(".hint-btn").forEach(e=>e.addEventListener("click",()=>async function(e){const t=document.getElementById("code-editor").value.trim();if(!t){const e=document.getElementById("hintModal"),t=document.getElementById("hintLoader"),n=document.getElementById("hintTerminal");return e.classList.remove("hidden"),window.isHintModalOpen=!0,t.classList.add("hidden"),n.innerText="Editor cannot be empty. Please write your code before asking for a hint.",void l()}!function(e){const t=p();t[e]=(t[e]||0)+1,localStorage.setItem(m,JSON.stringify(t));const n=Math.max(h.indexOf(e),h.indexOf(f()));localStorage.setItem(g,h[n])}(e);const n=document.getElementById("hintModal"),o=document.getElementById("hintLoader"),a=document.getElementById("hintTerminal");window.isHintModalOpen=!0,l(),n.classList.remove("hidden"),o.classList.remove("hidden"),a.innerText="Loading hint…";try{const n=JSON.parse(localStorage.getItem("selectedTask")||"{}"),i=parseInt(localStorage.getItem("loggedInUserId")||"1",10),d=parseInt(localStorage.getItem("sessionNumber")||"1",10),s=await fetch("/api/hints",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t,problemId:n.id,sessionNumber:d,type:e,userId:i})});let c="";const l=s.headers.get("content-type")||"";if(!s.ok)throw new Error("Hint fetch failed");if(l.includes("application/json")){const e=await s.json();c=e.hint||JSON.stringify(e)||"No hint found."}else c=await s.text()||"No hint found.";o.classList.add("hidden"),a.innerText=c,function(e,t){const n=JSON.parse(localStorage.getItem("selectedTask")||"{}"),o=JSON.parse(localStorage.getItem(u)||"[]");o.unshift({ts:(new Date).toISOString(),type:e,hint:t,taskTitle:n.title||"-"}),o.length>10&&(o.length=10),localStorage.setItem(u,JSON.stringify(o))}(e,c),I()}catch(e){o.classList.add("hidden"),a.innerText="Failed to fetch hint."}}(e.dataset.type))),y.addEventListener("click",()=>{E(),w(),location.href="dashboard"})})})();